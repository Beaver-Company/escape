machine:
  services:
  - docker
  environment:
    ESCAPE_PROJECT: "_"

dependencies:
  override:
  - curl https://storage.googleapis.com/escape-releases-eu/escape-v0.14.5.tgz > /home/ubuntu/bin/escape.tgz
  - tar -C /home/ubuntu/bin -xvzf /home/ubuntu/bin/escape.tgz

compile:
  override:
  - escape release
  - echo $GCLOUD_SERVICE_KEY | base64 --decode -i > ${HOME}/gcloud-service-key.json
  - escape deploy escape-client-latest -d "latest-client"
  - escape errands run upload_to_gcs -v bucket=escape-releases-eu -v credentials=@${HOME}/gcloud-service-key.json -d "latest-client"
  - escape errands run publish_binaries -v bucket=escape-releases-eu -v credentials=@${HOME}/gcloud-service-key.json -d "latest-client"
  - curl -f -X POST https://circleci.com/api/v1.1/project/github/ankyra/docker-escape-client/tree/master?circle-token=${CIRCLE_DOCKER_ESCAPE_TOKEN}

test:
  override:
  - echo "Already tested"

